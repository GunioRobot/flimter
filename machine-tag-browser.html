<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <script type="text/javascript" charset="utf-8" src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"></script>
  <script type="text/javascript">
    var apikey = "32ecf7b4565d138bd5ca10e10ab7fae5"; // yes, this is probably bad, but you don't get the secret at least
    var initial = {};

    // TODO - shouldn't be globals, should pass state around in closures
    var selected_namespace;
    var selected_predicate;
    var selected_tag;

    function hide_uncommon() {
      $("li.uncommon").slideUp();
    }

    function show_uncommon() {
      $("li.uncommon").slideDown();
    }

    var l0json =  function(data){
                    // TODO consider metaprogramming for json handers

                    // console.log(data);
                    for (var index = 0; index < data.namespaces.namespace.length; index++) {
                      var ns = data.namespaces.namespace[index]
                      $("ul#top div:first").append("<li class='level0' id='"+ns._content+"'>"+ns._content+" <span class='count'> "+ns.usage+"<"+"/span><span class='children'>"+ns.predicates+"<"+"/span><"+"/li>");
                      if (ns.usage < 10) {
                        $("li.level0:last").addClass("uncommon");
                      }
                    }

                    $("li.level0").click(l0click);
                    $("li.uncommon").hide();

                    // do we need to recurse?
                    if (data.namespaces.page < data.namespaces.pages) {
                      var page = data.namespaces.page+1;
                      $.getJSON("http://api.flickr.com/services/rest/?method=flickr.machinetags.getNamespaces&page="+page+"&api_key="+apikey+"&format=json&jsoncallback=?",
                        l0json);
                    } else {
                      $("ul#top div").show();
                      $("ul#top div#load").hide();

                      if ($('li.level0:contains('+initial['namespace']+")").length) {
                        offset = $('li.level0:contains('+initial['namespace']+'):first').offset().top;
                        offset = offset-($('ul#top').offset().top);
                        $('ul#top div').attr({scrollTop:offset});
                        $('li.level0:contains('+initial['namespace']+'):first').click();
                      }

                    }
                  };

    var l0click = function(){
                    // TODO sort out commonalities here and in l1click
                    selected_namespace = $(this).attr("id");

                    // Figure out if we've already asked for this predicate
                    var load = false;
                    if (!$(this).children("ul").length) {
                      load = true;
                      // Add and initialise the list element and the div
                      // container that's used to allow scrolling
                      $(this).append("<ul><div><"+"/div><"+"/ul>");
                      $(this).find("ul").css({
                        height:"100%",
                      });
                      $(this).find("ul div").css({
                        width:"250px",
                        height:"100%",
                        overflowX:"hidden",
                        overflowY:"scroll"
                      });
                    }

                    // show this item as selected, and others as not
                    $(this).siblings().css({backgroundColor:"#fff"});
                    $(this).css({backgroundColor:"rgb(27,115,213)"});

                    // hide other children, show this one
                    $(this).siblings().find("ul").hide();
                    $(this).children("ul").show();

                    if (load) {
                      // show a spinner
                      $(this).find("ul div").html("<img src='http://l.yimg.com/g/images/pulser2.gif' style='position:relative; top:100px;  left:109px;'>");

                      // actually call Flickr's API
                      $.getJSON("http://api.flickr.com/services/rest/?method=flickr.machinetags.getPredicates&namespace="+selected_namespace+"&api_key="+apikey+"&format=json&jsoncallback=?",
                        l1json
                      );
                    }

                    return false;

                  };

    var l1json =  function(data){
                    $("li#"+selected_namespace+" ul div img").remove();

                    for (var index=0; index < data.predicates.predicate.length; index++) {
                      var predicate = data.predicates.predicate[index]
                      $("li#"+selected_namespace+" ul div").append("<li id='"+predicate._content+"' class='level1'>"+predicate._content+" <span class='count'>"+predicate.usage+"<"+"/span><"+"/li>");
                    }

                    if (data.predicates.page < data.predicates.pages) {
                      var more = data.predicates.total - data.predicates.perpage
                      $("li#"+selected_namespace+" ul div").append("<li>... ("+more+" not shown)<"+"/li>");
                    }

                    $("li.level1").click(l1click)

                    if ($('li.level1:contains('+initial['predicate']+")").length) {
                      offset = $('li.level1:contains('+initial['predicate']+'):first').offset().top;
                      offset = offset-($('ul#top').offset().top);
                      $('li#'+selected_namespace+"ul div").attr({scrollTop:offset});
                      $('li.level1:contains('+initial['predicate']+'):first').click();
                    }

                  };

    var l1click = function(){
                    selected_predicate = $(this).attr("id");
                    // ns = $(this).parent().parent().parent().attr("id");

                    var load = false;
                    if (!$(this).children("ul").length) {
                      load = true;
                      $(this).append("<ul id='"+selected_namespace+"_"+selected_predicate+"'><div><"+"/div><"+"/ul>");
                      $(this).find("ul#"+selected_namespace+"_"+selected_predicate).css({
                        height:"100%",
                      });
                      $(this).find("ul#"+selected_namespace+"_"+selected_predicate+" div").css({
                        width: "250",
                        height:"100%",
                        overflowX:"hidden",
                        overflowY:"scroll"
                      });
                    };

                    $(this).siblings().css({backgroundColor:"#fff"});
                    $(this).css({backgroundColor:"rgb(27,115,213)"});

                    $(this).siblings().find("ul").hide();
                    $(this).children("ul").show();

                    if (load) {
                      $(this).find("ul#"+selected_namespace+"_"+selected_predicate+" div").html("<img src='http://l.yimg.com/g/images/pulser2.gif' style='position:relative; top:100px;  left:109px;'>");

                      $.getJSON("http://api.flickr.com/services/rest/?method=flickr.machinetags.getValues&namespace="+selected_namespace+"&predicate="+selected_predicate+"&api_key="+apikey+"&format=json&jsoncallback=?",
                        l2json
                      );
                    }

                    return false; // suppress level 0 click event
                  };

    var l2json =  function(data){
                    $("ul#"+selected_namespace+"_"+selected_predicate+" div img").remove();

                    for (var index = 0; index < data.values.value.length; index++) {
                      var value = data.values.value[index]
                      $("ul#"+selected_namespace+"_"+selected_predicate+" div").append("<li id='"+selected_namespace+"-"+selected_predicate+"-"+value._content.replace(/ /g, "-")+"' class='level2'>"+value._content+' <span class="count">'+value.usage+"<"+"/span><"+"/li>");
                    }

                    if (data.values.page < data.values.pages) {
                      var more = data.values.total-data.values.perpage
                      $("ul#"+selected_namespace+"_"+selected_predicate+" div").append("<li>... ("+more+" values not shown)<"+"/li>");
                    }
                    $("li.level2").click(l2click);

                    if ($('li.level2:contains('+initial['value']+")").length) {
                      console.log("selecting initial value "+initial['value']);
                      offset = $('li.level2:contains('+initial['value']+'):first').offset().top;
                      offset = offset-($('ul#top').offset().top);
                      $('ul#'+selected_namespace+"_"+selected_predicate+" div").attr({scrollTop:offset});
                      $('li.level2:contains('+initial['value']+'):first').click();
                    }

                  };

    var l2click = function(data) {
                    selected_tag = $(this).attr("id");
                    // ns = $(this).parent().parent().parent().attr("id");
                    console.log("selected tag "+selected_tag);

                    var load = false;
                    if (!$(this).children("ul").length) {
                      load = true;
                      $(this).append("<ul id='"+selected_tag+"'><div><"+"/div><"+"/ul>");
                      $(this).find("ul#"+selected_tag).css({
                        width: "100px",
                        height:"100%",
                      });
                      $(this).find("ul#"+selected_tag+" div").css({
                        width: "100px",
                        height:"100%",
                        overflowX:"hidden",
                        overflowY:"scroll"
                      });
                    };

                    $(this).siblings().css({backgroundColor:"#fff"});
                    $(this).css({backgroundColor:"rgb(27,115,213)"});

                    $(this).siblings().find("ul").hide();
                    $(this).children("ul").show();

                    if (load) {
                      $(this).find("ul#"+selected_tag+" div").html("<img src='http://l.yimg.com/g/images/pulser2.gif' style='position:relative; top:100px; left:34px;'>");
                      var flickr_tag = selected_tag.replace("-", ":");
                      flickr_tag = flickr_tag.replace("-", "=");
                      flickr_tag = flickr_tag.replace(/-/g, " ");
                      console.log("fetching tag "+flickr_tag);

                      $.getJSON("http://api.flickr.com/services/rest/?method=flickr.photos.search&tags="+flickr_tag+"&per_page=20&extras=owner_name&api_key="+apikey+"&format=json&jsoncallback=?",
                        l3json
                     );
                    }
                  };

    var l3json =  function(data) {
                    $("li#"+selected_tag+" ul div img").remove();

                    for (var index = 0; index < data.photos.photo.length; index++) {
                      var p = data.photos.photo[index];
                      html = '<li id="p_'+p.id+'"><a href="http://flickr.com/photos/'+p.owner+'/'+p.id+'/"><img src="http://farm'+p.farm+'.static.flickr.com/'+p.server+'/'+p.id+'_'+p.secret+'_s.jpg" width="75" height="75" alt="'+p.title+'" border="0"><'+'/a>';
                      $("li#"+selected_tag+" div").append(html);
                      $("li#"+selected_tag+" div li").click( function() { window.location = $(this).find('a').attr('href'); } );
                    }
                  };

    if (!window.console) {
      window.console = {
        'log':function() {}
      }
    }

    $(document).ready( function() {
      // $("ul#top").wrapInner(document.createElement("div"));
      // sod it, do this by hand, then set CSS by jQuery
      $("ul").height($(window).height()-$('div#blurb').height()-48);

      $("ul#top div:first").css({
        height:"100%",
        width:"250px",
        overflowX:"hidden",
        overflowY:"scroll"
      });
      $("ul#top div").hide();
      $("ul#top div#load").show();

      $.getJSON("http://api.flickr.com/services/rest/?method=flickr.machinetags.getNamespaces&api_key="+apikey+"&format=json&jsoncallback=?",
        l0json);

      var tag = window.location.search.substr(1);
      if (tag) {
        // TODO split with regex?
        var items1 = tag.split(":");
        initial["namespace"] = items1[0];
        if (items1[1]) {
          var items2 = items1[1].split("=");
          initial["predicate"] = items2[0];
          if (items2[1]) {
            initial["value"] = items2[1];
          }
        }
      }

      console.log(initial);
    });

  </script>
  <style type="text/css">
    /* set styles directly rather than using jQuery.css() calls,
     * or indeed an extra file, so that it's easier to edit/deploy.
     */
    body {
      background:#fff;
      color:#000;
      font:13/16px Arial, Helvetica, sans-serif;
    }

    h1 {
      font: 16px;
      font-weight: normal;
      line-height:10px;
    }

    ul {
      display:block;
      position:absolute;
      top:-1px;
      left:250px;
      padding:0;
      margin:0;
      width:250px;
      height:600px;
      border:1px solid rgb(178,178,178);
      background:#fff;
    }

    ul#top {
      width:850px;
    }

    li {
      list-style: none;
      padding: 2px;
    }

    li span.count {
      font-size: 80%;
      line-height:160%;
      color:#ccc;
    }

    li span.children {
      font-size: 80%;
      line-height:160%;
      color:#ccc;
      display:none;
    }

    li a {
      text-decoration:none;
      color:#000;
    }
    </style>
  <title>flickr machine tag explorer</title>
</head>
<body>
<div id="blurb">
  <h1>a flickr machine tag explorer</h1>

  <p>Browse Flickr machine tag namespaces, predicates and values. For more, see <a href="http://www.flickr.com/groups/api/discuss/72157594497877875/">this post about machine tags</a> and <a href="http://tech.groups.yahoo.com/group/yws-flickr/message/4545">this post about new API methods</a> (which enabled this hack to be built).</p>

  <p>A Flickr hack by <a href="http://husk.org/">Paul Mison</a>. Browser view code inspired by <a href="http://code.google.com/p/jquery-column-navigation/">jQuery Column Navigator</a>. Not associated with Flickr (but I use their pulser because I'm lazy, sorry). <a href="http://github.com/blech/flimter/tree/master">At Github.</a></p>

  <p>TODO: make ... work in predicates+values / sort by count (total or child) / offer all namespaces browser / debug wonky clicks /<br>
           final column links to picture view / take arguments for initial namespace/predicate (ta yoz)</p>

  <p>Show <a href="#" onclick="javascript:$('span.children').show(); $('span.count').hide(); return false;">children</a>
        | <a href="#" onclick="javascript:$('span.count').show(); $('span.children').hide(); return false;">count</a>.

          <a href="#" onclick="javascript:hide_uncommon(); return false;">Hide uncommon namespaces</a>

        | <a href="#" onclick="javascript:show_uncommon(); return false;">Show uncommon namespaces</a>

  </p>

</div>

<div style="position:relative; left:-250px;">
  <ul id="top">
    <div></div>
    <div id='load'>
      <img src='http://l.yimg.com/g/images/pulser2.gif' style='position:relative; top:100px;  left:359px;'>
    </div>
</ul>

</div>

<!-- I thought I'd like to know if anyone was watching -->
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-5271055-2");
pageTracker._trackPageview();
} catch(err) {}</script>

</body>
</html>
